# This is a basic workflow to help you get started with Actions
name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on any branch or tag commit
  push:
    branches:
      - "*"
    tags:
      - "v*"

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  # Este trabajo maneja el despliegue
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Python packages
        run: pip install -r requirements.txt
        
      - name: Creates pipeline
        env:
          SF_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
          SF_USER: ${{ secrets.SF_USER }}
          SF_PWD: ${{ secrets.SF_PWD }}
          SF_ROLE: ${{ secrets.SF_ROLE }}
          SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SF_DATABASE: ${{ secrets.SF_DATABASE }}
          SF_SCHEMA: ${{ secrets.SF_SCHEMA }}
        run: python $GITHUB_WORKSPACE/model.py

      - name: Promote tables to production
        run: |
          snowsql -c your_connection -q "
            BEGIN;

            -- Insertar datos en la tabla SALES_ADVERTISING
            INSERT INTO REGRESSION_DB.PUBLIC.SALES_ADVERTISING (ID, ADVERTISING_EXPENSE, SALES) VALUES
            (33, 100.00, 200.00),
            (33, 300.00, 400.00);

            -- Si todo fue exitoso, hacer commit
            COMMIT;
          "
        continue-on-error: true

      - name: Rollback table promotion
        if: failure()
        run: |
          echo "Error during table promotion, rollback initiated"
          snowsql -c your_connection -q "ROLLBACK;"
